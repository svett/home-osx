#!/usr/bin/env sh -e

[ -z "$DEBUG" ] || set -x

RELOAD_SERVICES=()

main() {
  osx_software_update

  install_brew_if_not_exists
  install_brew_update
  install_ruby

  osx_configure
  osx_appstore_update
  git_configure
  reload_modified_services

  update_golang_packages
  update_tmux_plugins
  install_vim

  symlink_ssl
}

install_brew_if_not_exists() {
  if [[ ! -x /usr/local/bin/brew ]] ; then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
}

install_brew_update() {
  pushd "${HOME}/etc"
    brew tap Homebrew/bundle
    brew update
    brew bundle
    brew bundle cleanup
  popd
}

install_ruby() {
  echo "Setting up ruby..."
  # chruby contains unbound variables
  set +u
  source /usr/local/share/chruby/chruby.sh

  if chruby $(cat "${HOME}/.ruby-version") > /dev/null 2>&1; then
    echo "$(cat "${HOME}/.ruby-version") already installed..."
  else
    echo "will install $(cat "${HOME}/.ruby-version")..."
    ruby-install $(cat ~/.ruby-version)
  fi
  set -u
}

osx_software_update() {
  softwareupdate --install --all
}

osx_configure() {
  local config

  pushd "${HOME}/etc/defaults" >&-
    for config in *
    do
      # shellcheck source=/dev/null
      . "$config"
    done
  popd >&-
}

git_configure() {
  echo "Ensuring git configs are set up..."
  local gitconfig

  if [[ ! -f "${HOME}/.gitconfig" ]] ; then
    write_git_config
  fi

  if [[ $(head -n2 "${HOME}/.gitconfig") != "[include]
  path = ${HOME}/.gitconfig_00_base" ]] ; then
    gitconfig=$(cat "${HOME}/.gitconfig")
    write_git_config
    echo "${gitconfig}" >> "${HOME}/.gitconfig"
  fi
}

write_git_config() {
    echo "[include]" > "${HOME}/.gitconfig"
    echo "  path = ${HOME}/.gitconfig_00_base" >> "${HOME}/.gitconfig"
}

symlink_ssl() {
  ln -s /usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib /usr/local/lib/
  ln -s /usr/local/opt/openssl/lib/libssl.1.0.0.dylib /usr/local/lib/
}

osx_appstore_update() {
  if which mas >&-
  then
    mas outdated | while read -r app_id_and_name
    do
      echo "Updating ${app_id_and_name##* }..."
      mas install "${app_id_and_name%% *}"
    done
  fi
}

reload_modified_services() {
  local modified_services=(${RELOAD_SERVICES[@]:?must be defined})
  local modified_services_uniq=(
    $(printf "%s\n" "${modified_services[@]}" | sort -u)
  )

  killall "${modified_services_uniq[@]}"
}

install_vim() {
  . "${HOME}/.vim/install"
}

update_tmux_plugins() {
  . "${HOME}/.tmux/plugins/tpm/bin/install_plugins" || true
  . "${HOME}/.tmux/plugins/tpm/bin/update_plugins" all || true
}

update_golang_packages() {
export GOPATH="${GOPATH:-"${HOME}/go"}"

pushd "${HOME}/go/packages" >&-
 for pkg in *
 do
  go get "${pkg//\~//}"
 done
popd >&-
}

main
